#!/usr/bin/env bash

get_battery_status() {
    local PATH_AC="/sys/class/power_supply/AC"
    local PATH_BATTERY_0="/sys/class/power_supply/BAT0"
    local PATH_BATTERY_1="/sys/class/power_supply/BAT1"

    local ac=0
    local battery_level_0=0
    local battery_level_1=0
    local battery_max_0=0
    local battery_max_1=0

    if [ -f "${PATH_AC}/online" ]; then
        ac=$(cat "${PATH_AC}/online")
    fi

    if [ -f "${PATH_BATTERY_0}/energy_now" ]; then
        battery_level_0=$(cat "${PATH_BATTERY_0}/energy_now")
    fi

    if [ -f "${PATH_BATTERY_0}/energy_full" ]; then
        battery_max_0=$(cat "${PATH_BATTERY_0}/energy_full")
    fi

    if [ -f "${PATH_BATTERY_1}/energy_now" ]; then
        battery_level_1=$(cat "${PATH_BATTERY_1}/energy_now")
    fi

    if [ -f "${PATH_BATTERY_1}/energy_full" ]; then
        battery_max_1=$(cat "${PATH_BATTERY_1}/energy_full")
    fi

    local battery_level=$((${battery_level_0} + ${battery_level_1}))
    local battery_max=$((${battery_max_0} + ${battery_max_1}))
    local battery_percent=$((${battery_level} * 100 / ${battery_max}))

    echo -e "${ac}${battery_percent}"
}

fire_battery_alert() {
    local battery_status=$1
    local ac=${battery_status:0:1}
    local battery_percent=${battery_status:1}

    local threshold_low=10
    local threshold_critically_low=5
    local threshold_suspend=3

    local msgid_low=243595
    local msgid_critically_low=669326

    if [[ $ac -eq 1 ]]; then
        dunstify --close $msgid_low
        dunstify --close $msgid_critically_low
    elif [[ $battery_percent -le $threshold_suspend ]]; then
        systemctl suspend
    elif [[ $battery_percent -le $threshold_critically_low ]]; then
        dunstify --urgency critical                                                  \
                 --hints int:value:${battery_percent} "Battery: ${battery_percent}%" \
                 --replace $msgid_critically_low                                     \
                 --icon battery-empty-symbolic
    elif [[ $battery_percent -le $threshold_low ]]; then
        dunstify --urgency normal                                                    \
                 --hints int:value:${battery_percent} "Battery: ${battery_percent}%" \
                 --replace $msgid_low                                                \
                 --icon battery-low-symbolic
    fi
}

check_battery() {
    local battery_percent=$(get_battery_status)
    fire_battery_alert $battery_percent
}

# monitor battery
while :; do
    check_battery

    sleep 60 || break
done &

udevadm monitor --udev --subsystem-match power_supply |
    while read event; do
        check_battery
    done &
