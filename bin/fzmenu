#!/usr/bin/env bash

dirs=(
    /usr/share/applications
    /usr/local/share/applications
    $HOME/.local/share/applications
)

# in the dirs, build a dictionary:
# xyz.desktop -> /path/to/xyz.desktop
declare -A files
for d in "${dirs[@]}"; do
    for f in $(ls -1 ${d}/*.desktop 2> /dev/null); do
        name=${f##*/}
        files[$name]=$f
    done
done

# display name -> /path/to/xyz.desktop
declare -A menu
for f in "${files[@]}"; do
    grep '^NoDisplay=true' $f &> /dev/null
    if [[ $? -ne 0 ]]; then
        name=$(grep -m1 '^Name=' $f | cut -d= -f2-)
        menu["$name"]=$f
    fi
done

pick=$(printf '%s\n' "${!menu[@]}" | sort | fzf --reverse \
                                                --no-info \
                                                --border  \
                                                --prompt "Run: ")

if [[ -n $pick ]]; then
    set -m
    kill -SIGHUP $PPID
    gio launch ${menu[$pick]} &
fi
