#!/usr/bin/env bash

[[ "${FLOCKER}" != "$0" ]] && exec env FLOCKER="$0" flock -Fxn "$0" "$0" "$@" || :

set -m

dirs=(
    /usr/share/applications
    /usr/local/share/applications
    $HOME/.local/share/applications
)

# in the dirs, build a dictionary:
# xyz.desktop -> /path/to/xyz.desktop
declare -A files
for d in "${dirs[@]}"; do
    for f in $(ls -1 ${d}/*.desktop 2> /dev/null); do
        name=${f##*/}
        files[$name]=$f
    done
done

# display name -> /path/to/xyz.desktop
declare -A menu
for f in "${files[@]}"; do
    grep '^NoDisplay=true' $f &> /dev/null
    if [[ $? -ne 0 ]]; then
        name=$(grep -m1 '^Name=' $f | cut -d= -f2-)
        menu["$name"]=$f
    fi
done

pick=$(printf '%s\n' "${!menu[@]}"                  \
           | sort                                   \
           | fzf --reverse                          \
               --no-info                            \
               --border                             \
               --scrollbar â”† --color scrollbar:blue \
               --prompt "Run: ")

if [[ -n $pick ]]; then
    kill -SIGHUP $PPID
    gio launch ${menu[$pick]} &> /dev/null &
fi
