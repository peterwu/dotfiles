# -*- coding: utf-8 -*-
#+STARTUP: overview

My Emacs Init Settings

* System Customization
** Keep customizations made through the M-x customize function into its own file.
#+BEGIN_SRC emacs-lisp
  (setq custom-file (locate-user-emacs-file "custom.el"))
  (load custom-file)
#+END_SRC
* Package Management 
  This section documents what packages that have been installed and configured.
** Add melpa repo
#+BEGIN_SRC emacs-lisp
  (require 'package)
  (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
  (package-initialize)
#+END_SRC
** Personal scripts
#+BEGIN_SRC emacs-lisp
  (add-to-list 'load-path (expand-file-name "elisp" user-emacs-directory))
#+END_SRC
** Install =use-package= if not
#+BEGIN_SRC emacs-lisp
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))
  (eval-when-compile
    (require 'use-package))
  (setq use-package-always-ensure t)
#+END_SRC
** Keep installed packages up to date automatically
#+BEGIN_SRC emacs-lisp
  (use-package auto-package-update
    :init
    (setq auto-package-update-last-update-day-filename (expand-file-name "cache/last-package-update-day" user-emacs-directory))
    :config
    (setq auto-package-update-delete-old-versions t)
    (setq auto-package-update-hide-results t)
    (auto-package-update-maybe))
#+END_SRC 
** Install which-key
#+BEGIN_SRC emacs-lisp
  (use-package which-key
    :init
    (which-key-mode))
#+END_SRC
** Theme
#+BEGIN_SRC emacs-lisp
  (use-package solarized-theme
    :init
    (setq solarized-distinct-fringe-background t)
    (setq solarized-use-variable-pitch nil)
    (setq solarized-high-contrast-mode-line t)
    (setq solarized-use-less-bold t)
    (setq solarized-use-more-italic t)
    (setq solarized-emphasize-indicators nil)
    (setq solarized-scale-org-headlines nil)

    ;; Avoid all font-size changes
    (setq solarized-height-minus-1 1.0)
    (setq solarized-height-plus-1 1.0)
    (setq solarized-height-plus-2 1.0)
    (setq solarized-height-plus-3 1.0)
    (setq solarized-height-plus-4 1.0)
    :config
    (setq frame-background-mode 'dark)
    (when (or window-system
	      (eq system-type 'windows-nt))
      (load-theme 'solarized-dark t))

    (defconst theme-color-black "#073642")
    (defconst theme-color-red "#dc322f")
    (defconst theme-color-green "#859900")
    (defconst theme-color-yellow "#b58900")
    (defconst theme-color-orange "#cb4b16")
    (defconst theme-color-blue "#268bd2")
    (defconst theme-color-violet "#6c71c4")
    (defconst theme-color-magenta "#d33682")
    (defconst theme-color-cyan "#2aa198")
    (defconst theme-color-white "#eee8d5"))
#+END_SRC
** Minions
#+BEGIN_SRC emacs-lisp
  (use-package minions
    :config (minions-mode 1))
#+END_SRC
** Ace-window
#+BEGIN_SRC emacs-lisp
  (use-package ace-window
    :bind
    ([remap other-window] . ace-window)
    :config
    (set-face-attribute 'aw-leading-char-face nil
			:height 3.0
			:box t))
#+END_SRC
** Evil and related packages
Simulate a Vim modal editing experience
#+BEGIN_SRC emacs-lisp
  (use-package evil
    :init
    (setq evil-want-integration t)
    (setq evil-want-keybinding nil)
    :config
    (evil-mode t)
    (setq evil-mode-line-format '(after . mode-line-front-space)))

  (use-package evil-collection
    :after evil
    :custom
    (evil-collection-setup-minibuffer t)
    :config
    (evil-collection-init))

  (use-package evil-commentary
    :config
    (evil-commentary-mode t))

  (use-package evil-surround
    :config  
    (global-evil-surround-mode t))

  (use-package evil-goggles
    :config  
    (setq evil-goggles-pulse t)
    (evil-goggles-mode))

  (use-package evil-matchit
    :config  
    (global-evil-matchit-mode t))

  (use-package evil-quickscope
    :config
    (global-evil-quickscope-mode t))

  (use-package evil-mc
    :config
    (global-evil-mc-mode 1))

  (use-package evil-numbers
    :config
    (define-key evil-normal-state-map (kbd "C-c +") 'evil-numbers/inc-at-pt)
    (define-key evil-normal-state-map (kbd "C-c -") 'evil-numbers/dec-at-pt))

  (use-package evil-args
    :config
    ;; bind evil-args text objects
    (define-key evil-inner-text-objects-map "a" 'evil-inner-arg)
    (define-key evil-outer-text-objects-map "a" 'evil-outer-arg)

    ;; bind evil-forward/backward-args
    (define-key evil-normal-state-map "L" 'evil-forward-arg)
    (define-key evil-normal-state-map "H" 'evil-backward-arg)
    (define-key evil-motion-state-map "L" 'evil-forward-arg)
    (define-key evil-motion-state-map "H" 'evil-backward-arg)
    ;; bind evil-jump-out-args
    (define-key evil-normal-state-map "K" 'evil-jump-out-args))

  (require 'evil-unimpaired)
  (evil-unimpaired-mode)
#+END_SRC
** Magit for Git
#+BEGIN_SRC emacs-lisp
  (use-package magit
    :config
    (global-set-key (kbd "C-x g") 'magit-status))

  (use-package evil-magit
    :after evil magit
    :config
    (setq evil-magit-state 'normal))
#+END_SRC
** Sudo-edit
#+BEGIN_SRC emacs-lisp
  (use-package sudo-edit
    :bind ("s-e" . sudo-edit))
#+END_SRC
** Rainbow
#+BEGIN_SRC emacs-lisp
  (use-package rainbow-mode
    :hook prog-mode)
#+END_SRC
#+BEGIN_SRC emacs-lisp
  (use-package rainbow-delimiters
    :config
    (rainbow-delimiters-mode 1))
#+END_SRC
** Org mode
#+BEGIN_SRC emacs-lisp
    (use-package org
      :init
      (setq org-fontify-whole-heading-line t)
      (setq org-support-shift-select t)
      (setq org-odt-convert-process 'unoconv)
      (setq org-odt-preferred-output-format "docx")
      (setq org-agenda-files (list "~/Documents/agendas"))
      (setq org-capture-templates
	    '(("t" "Todo" entry (file+headline "~/Documents/Org/gtd.org" "Tasks")
	       "* TODO %?\n  %i\n  %a")
	      ("n" "Notes" entry (file+headline "~/Documents/Org/notes.org" "Notes")
	       "* Notes %?\n  %i\n  %a")
	      ("j" "Journal" entry (file+olp+datetree "~/Documents/Org/journal.org")
	       "* %?\nEntered on %U\n  %i\n  %a")))
      :config
      (global-set-key (kbd "C-c l") 'org-store-link)
      (global-set-key (kbd "C-c a") 'org-agenda)
      (global-set-key (kbd "C-c c") 'org-capture)
      (global-set-key (kbd "C-c b") 'org-switchb))
#+END_SRC
*** Org-bullets
#+BEGIN_SRC emacs-lisp
  (use-package org-bullets
    :config
    (add-hook 'org-mode-hook 'org-bullets-mode))
#+END_SRC
*** org-templates
#+BEGIN_SRC emacs-lisp
  (add-to-list 'org-structure-template-alist
	       '("el" "#+BEGIN_SRC emacs-lisp\n?\n#+END_SRC"))
#+END_SRC
=======
** Projectile
#+BEGIN_SRC emacs-lisp
  (use-package projectile
    :init
    (setq projectile-cache-file (expand-file-name "cache/projectile.cache" user-emacs-directory)
	  projectile-known-projects-file (expand-file-name "cache/projectile-bookmarks.eld" user-emacs-directory))
    :config
    (define-key projectile-mode-map (kbd "C-c p") 'projectile-command-map)
    (projectile-mode t)
    (add-to-list 'projectile-globally-ignored-directories "node_modules")
    (setq projectile-completion-system 'ivy))

  (use-package counsel-projectile
    :config
    (counsel-projectile-mode))
#+END_SRC
** Company for auto completion
#+BEGIN_SRC emacs-lisp
  (use-package company
    :config
    (setq company-idle-delay 0
	  company-minimum-prefix-length 3)
    (global-company-mode t))
#+END_SRC
** Search
*** Avy
    #+BEGIN_SRC emacs-lisp
      (use-package avy
	:bind ("M-s" . avy-goto-char))
    #+END_SRC
*** Ivy
 #+BEGIN_SRC emacs-lisp
   (use-package ivy
     :init (ivy-mode 1)
     :bind (("C-c C-r" . ivy-resume)
	    ("<f6>" . ivy-resume))
     :config
     (setq ivy-use-virtual-buffers t)
     (setq enable-recursive-minibuffers t))
 #+END_SRC
*** Swiper
    #+BEGIN_SRC emacs-lisp
      (use-package swiper
	:bind ("C-s" . swiper))
    #+END_SRC
*** Counsel
 #+BEGIN_SRC emacs-lisp
   (use-package counsel
     :bind
     (("C-x C-f" . counsel-find-file)
      ("<f1> u" . counsel-unicode-char)))
 #+END_SRC
** Treemacs
#+BEGIN_SRC emacs-lisp
  (use-package treemacs
    :defer t
    :bind
    (([f8] . treemacs)
     ("M-0" . treemacs-select-window))
    :config
    (setq treemacs-persist-file
	  (expand-file-name "cache/treemacs-persist" user-emacs-directory)))
#+END_SRC
*** Evil support
#+BEGIN_SRC emacs-lisp
  (use-package treemacs-evil
    :after treemacs evil)
#+END_SRC
*** Projectile integration
#+BEGIN_SRC emacs-lisp
  (use-package treemacs-projectile
    :after treemacs projectile)
#+END_SRC
*** Use pretty icons
#+BEGIN_SRC emacs-lisp
  (use-package treemacs-icons-dired
    :disabled
    :after treemacs dired
    :config (treemacs-icons-dired-mode))
#+END_SRC
** Yasnippets
 #+BEGIN_SRC emacs-lisp
   (use-package yasnippet
     :config
     (use-package yasnippet-snippets)
     (yas-global-mode 1))
 #+END_SRC
** Gnus
#+BEGIN_SRC emacs-lisp
  (use-package gnus
    :defer t
    :init
    (setq read-mail-command 'gnus)
    (setq user-mail-address "peterwu@hotmail.com"
	  user-full-name "Peter Wu")
    ;; (setq mm-text-html-renderer 'gnus-w3m)
    ;; Use webkit when it's mature enough
    ;; https://gist.github.com/orgcandman/1e53ca99dd3899b07e5743718a1db300
    (setq gnus-select-method
	  '(nnimap "hotmail"
		   (nnimap-address "imap-mail.outlook.com")
		   (nnimap-server-port 993)
		   (nnimap-stream ssl)))
    (setq smtpmail-smtp-server "smtp-mail.outlook.com"
	  smtpmail-smtp-service 587))
#+END_SRC
** Various file types
*** YAML files
 #+BEGIN_SRC emacs-lisp
   (use-package yaml-mode)
 #+END_SRC
*** Read ePub files
 #+BEGIN_SRC emacs-lisp
   (use-package nov 
     :mode ("\\.epub\\'" . nov-mode)
     :init
     (setq nov-save-place-file (expand-file-name "cache/nov-places" user-emacs-directory))
     :config
     (add-hook 'nov-mode-hook (lambda ()
				(face-remap-add-relative 'default :height 1.2)
				(display-line-numbers-mode -1))))
 #+END_SRC
*** Edit Vuejs files
 #+BEGIN_SRC emacs-lisp
   (use-package vue-mode
     :mode "\\.vue\\'")
 #+END_SRC
*** gRPC/Proto
 #+BEGIN_SRC emacs-lisp
   (use-package protobuf-mode)
 #+END_SRC
*** Json
 #+BEGIN_SRC emacs-lisp
   (use-package json-mode)
 #+END_SRC
*** Markdown
 #+BEGIN_SRC emacs-lisp
   (use-package markdown-mode
     :init (setq markdown-command "multimarkdown"))
 #+END_SRC
*** Vimrc
#+BEGIN_SRC emacs-lisp
  (use-package vimrc-mode)
#+END_SRC
* Personal Settings
** Variables
#+BEGIN_SRC emacs-lisp
  (set-language-environment "utf-8")
  (setq inhibit-startup-screen t
	inhibit-startup-echo-area-message t)
  (setq backup-inhibited t
	make-backup-files nil
	auto-save-default nil
	auto-save-list-file-prefix nil)
  (setq scroll-step 1
	scroll-margin 1
	scroll-conservatively 10000
	auto-window-vscroll nil)
  (setq vc-follow-symlinks nil)
  (setq delete-by-moving-to-trash t)
  (setq display-line-numbers-type 'relative)
  (setq display-time-24hr-format t
	display-time-format "[%R]"
	display-time-default-load-average nil)
  (setq visible-bell t)
  (when (eq system-type 'windows-nt)
    (setq inhibit-compacting-font-caches t)) 
  (setq recentf-save-file (expand-file-name "cache/recentf" user-emacs-directory))
  (setq bookmark-default-file (expand-file-name "cache/bookmarks" user-emacs-directory))
  (setq tramp-persistency-file-name (expand-file-name
				     "cache/tramp" user-emacs-directory))
#+END_SRC
** Functions
#+BEGIN_SRC emacs-lisp
  (fset 'yes-or-no-p 'y-or-n-p)
#+END_SRC
** Modes
#+BEGIN_SRC emacs-lisp
  (global-visual-line-mode t)
  (column-number-mode t)
  (if window-system
      (global-hl-line-mode 1)
    (global-hl-line-mode -1))
  (electric-pair-mode t)
  (show-paren-mode t)
  (size-indication-mode t)
  (global-display-line-numbers-mode t)
  (display-battery-mode t)
  (display-time-mode t)

  (menu-bar-mode -1)
  (scroll-bar-mode -1)
  (tool-bar-mode -1)

  ;; (dolist (hook '(text-mode-hook))
  ;;   (add-hook hook (lambda () (flyspell-mode 1))))
  ;; (dolist (hook '(change-log-mode-hook log-edit-mode-hook))
  ;;   (add-hook hook (lambda () (flyspell-mode -1))))
#+END_SRC
** Faces
#+BEGIN_SRC emacs-lisp
  ;; default face
  (set-face-attribute 'default nil
		      :family "Iosevka"
		      :foundry "outline"
		      :slant 'normal
		      :weight 'normal
		      :height 120
		      :width 'normal)

  (add-hook 'display-line-numbers-mode-hook
	    (lambda ()
	      (set-face-attribute 'line-number nil
				  :weight 'normal)
	      (set-face-attribute 'line-number-current-line nil
				  :foreground (face-attribute 'cursor :background)
				  :weight 'bold
				  :underline t)))
#+END_SRC
** UI settings
#+BEGIN_SRC emacs-lisp
  ;; (unless (eq system-type 'windows-nt)
  ;;   (add-to-list 'default-frame-alist '(fullscreen  . t)))
#+END_SRC
** Key bindings
#+BEGIN_SRC emacs-lisp
  (global-set-key [f12] 'eshell)
  (global-set-key (kbd "C-x C-b") 'ibuffer)
  (global-set-key [mouse-3] 'mouse-popup-menubar-stuff)
#+END_SRC
** Mode line
#+BEGIN_SRC emacs-lisp
  (require 'ixl-display-weather)
  (ixl-display-weather-info)
#+END_SRC
** EShell prompt
#+BEGIN_SRC emacs-lisp
  (defun ixl/pwd-shorten-dirs (pwd)
    "Shorten all directory names in PWD except the last two."
    (let ((p-lst (split-string pwd "/")))
      (if (> (length p-lst) 2)
	  (concat
	   (mapconcat (lambda (elm) (if (zerop (length elm)) ""
				      (substring elm 0 1)))
		      (butlast p-lst 2)
		      "/")
	   "/"
	   (mapconcat (lambda (elm) elm)
		      (last p-lst 2)
		      "/"))
	pwd)))  ;; Otherwise, we just return the PWD

  (defun ixl/pwd-replace-home (pwd)
    "Replace home in PWD with tilde (~) character."
    (interactive)
    (let* ((home (expand-file-name (getenv "HOME")))
	   (home-len (length home)))
      (if (and
	   (>= (length pwd) home-len)
	   (equal home (substring pwd 0 home-len)))
	  (concat "~" (substring pwd home-len))
	pwd)))

  (defun ixl/eshell-prompt ()
    (require 's)
    (concat
     (propertize "↪ " 'face
		 (if (= eshell-last-command-status 1)
		     `(:foreground ,theme-color-red)
		   `(:foreground ,theme-color-green)))
     (propertize (ixl/pwd-shorten-dirs
		  (ixl/pwd-replace-home (eshell/pwd))) 'face `(:foreground ,theme-color-blue))
     (when (locate-dominating-file (eshell/pwd) ".git")
       (let* ((git-status (shell-command-to-string "git status --porcelain"))
	      (git-branch (s-chomp (shell-command-to-string "git rev-parse --abbrev-ref HEAD"))))
	 (concat " " (propertize git-branch 'face (list :foreground
							(if (string-empty-p git-status)
							    (concat theme-color-green)
							  (concat theme-color-red)))))))
     "\n" 
     (if (= (user-uid) 0)
	 (propertize "Λ" 'face `(:foreground ,theme-color-red))
       "λ")
     " "))
  (setq eshell-prompt-function 'ixl/eshell-prompt)
  (setq eshell-highlight-prompt nil)
#+END_SRC
